<div class="card my-4" id="group-role-select-table">
  <div class="card-header bg-body" id="tableHeader">
    <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#tableCollapse" aria-expanded="true" aria-controls="tableCollapse">
      Assign group roles <i class="far fa-caret-square-down"></i>
    </button>
  </div>
  <div id="tableCollapse" class="collapse show">
    <div class="p-4">
      <p>
        This assessment contains group roles. Use this table to view the role assignments of the current group members and reassign roles as needed. If the current group role configuration is invalid, errors will be shown.
      </p>
      <% if (!rolesInfo.rolesAreBalanced) { %>
        <div class="alert alert-danger my-2" role="alert">
          A user has too many roles. Every student should be assigned to exactly <strong>one</strong> role with group size <strong><%= groupSize %></strong> 
        </div>
      <% } %>
      <% if (typeof rolesInfo.validationErrors !== 'undefined' && rolesInfo.validationErrors.length > 0) { %>
        <% rolesInfo.validationErrors.forEach(function ({ role_id, role_name, count, minimum, maximum }) { %>
          <div class="alert alert-danger my-2" role="alert">
            <% if (count < minimum) { %>
              <%= minimum - count %> more <%= minimum - count === 1 ? 'person needs' : 'people need' %> to be assigned <%= role_name %>.
            <% } else if (count > maximum) { %>
              <%= count - maximum %> less <%= count - maximum === 1 ? 'person needs' : 'people need' %> to be assigned <%= role_name %>.
            <% } %>
            <% if (maximum === minimum) { %>
              (Found <%= count %>, expected exactly <%= minimum %>).
            <% } else { %>
              (Found <%= count %>, expected between <%= minimum %> and <%= maximum %>).
            <% } %>
          </div>
        <% }) %>
      <% } %>
      <% if (typeof rolesInfo.usersWithoutRoles !== 'undefined' && rolesInfo.usersWithoutRoles.length > 0) { %>
        <div class="alert alert-danger my-2" role="alert">
          At least one user does not have a role. All users must have a role.
        </div>
      <% } %>
      <form id="role-select-form" name="role-select-form" method="POST">
        <table class="table table-bordered table-striped my-3 px-3">
          <thead>
            <tr>
              <th scope="col">User</th>
              <th scope="col">Roles</th>
            </tr>
          </thead>
          <tbody>
            <% groupMembers.forEach(function (user) { %>
            <tr>
              <td><%= user.uid %></td>
              <td>
                <% rolesInfo.groupRoles.forEach(function (role) { %>
                  <input
                    class="ml-2"
                    type="checkbox"
                    id="user_role_<%= role.id %>-<%= user.user_id %>"
                    name="user_role_<%= role.id %>-<%= user.user_id %>"
                    <% if (rolesInfo.disabledRoles.includes(role.role_name)) { %>
                      disabled
                    <% } else if (rolesInfo.roleAssignments[user.uid] !== undefined && rolesInfo.roleAssignments[user.uid].find((a) => a.role_name === role.role_name) !== undefined) { %>
                      checked
                    <% }%>
                    form="role-select-form"
                  >
                  <label for="user_role_<%= role.id %>-<%= user.user_id %>" <% if (rolesInfo.disabledRoles.includes(role.role_name)) { %> class="text-muted" <% } %>>
                    <%= role.role_name %>
                  </label>
                <% }) %>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
        <div class="my-4 d-flex justify-content-center">
          <input type="hidden" name="__action" value="update_group_roles" />
          <input type="hidden" name="__csrf_token" value="<%= __csrf_token %>" />
          <button type="submit" class="btn btn-primary">Update Roles</button>
        </div>
      </form>
    </div>
  </div>
</div>